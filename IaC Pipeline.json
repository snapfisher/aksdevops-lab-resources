{"source":2,"revision":124,"description":null,"createdBy":{"displayName":"Paul Fisher","url":"https://spsprodcus3.vssps.visualstudio.com/A6c8c987f-7343-41a1-a01c-9d4ca1308e2d/_apis/Identities/aa3d446b-9215-448b-949e-8792b36a0fda","_links":{"avatar":{"href":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"}},"id":"aa3d446b-9215-448b-949e-8792b36a0fda","uniqueName":"pfisher@microsoft.com","imageUrl":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw","descriptor":"aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"},"createdOn":"2020-02-19T15:11:34.997Z","modifiedBy":{"displayName":"Paul Fisher","url":"https://spsprodcus3.vssps.visualstudio.com/A6c8c987f-7343-41a1-a01c-9d4ca1308e2d/_apis/Identities/aa3d446b-9215-448b-949e-8792b36a0fda","_links":{"avatar":{"href":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"}},"id":"aa3d446b-9215-448b-949e-8792b36a0fda","uniqueName":"pfisher@microsoft.com","imageUrl":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw","descriptor":"aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"},"modifiedOn":"2020-03-01T18:52:35.867Z","isDeleted":false,"lastRelease":{"id":133,"name":"Release-98","artifacts":[],"_links":{},"description":"","releaseDefinition":{"id":2,"projectReference":null,"_links":{}},"createdOn":"2020-03-01T18:55:27.833Z","createdBy":{"displayName":"Paul Fisher","url":"https://spsprodcus3.vssps.visualstudio.com/A6c8c987f-7343-41a1-a01c-9d4ca1308e2d/_apis/Identities/aa3d446b-9215-448b-949e-8792b36a0fda","_links":{"avatar":{"href":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"}},"id":"aa3d446b-9215-448b-949e-8792b36a0fda","uniqueName":"pfisher@microsoft.com","imageUrl":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw","descriptor":"aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"}},"variables":{"aksClusterGroupName":{"value":"lab6"},"deploymentName":{"value":"workingdeployment"},"location":{"value":"westus2"},"system.debug":{"value":"false"}},"variableGroups":[],"environments":[{"id":2,"name":"IaC Deployment","rank":1,"owner":{"displayName":"Paul Fisher","url":"https://spsprodcus3.vssps.visualstudio.com/A6c8c987f-7343-41a1-a01c-9d4ca1308e2d/_apis/Identities/aa3d446b-9215-448b-949e-8792b36a0fda","_links":{"avatar":{"href":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"}},"id":"aa3d446b-9215-448b-949e-8792b36a0fda","uniqueName":"pfisher@microsoft.com","imageUrl":"https://dev.azure.com/restonmtc/_apis/GraphProfile/MemberAvatars/aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw","descriptor":"aad.M2E5YmFlMGUtM2M4MS03ZDFmLTk1MzUtZDc0NTJlYzE0ZTAw"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":4}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":5},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":6}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"ubuntu-18.04"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":710,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"94a74903-f93f-4075-884f-dc11f34058b4","version":"2.*","name":"Deploy AKS and AGIC","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceName":"40936c25-3e9b-4afc-b6dc-b58d879a8058","action":"Create Or Update Resource Group","resourceGroupName":"$(aksClusterGroupName)","location":"$(location)","templateLocation":"Linked artifact","csmFileLink":"","csmParametersFileLink":"","csmFile":"$(System.DefaultWorkingDirectory)/_snapfisher_Lab6AksDo/lab6project/template.json","csmParametersFile":"$(System.DefaultWorkingDirectory)/_snapfisher_Lab6AksDo/lab6project/parameters.json","overrideParameters":"","deploymentMode":"Incremental","enableDeploymentPrerequisites":"None","deploymentGroupEndpoint":"","project":"","deploymentGroupName":"","copyAzureVMTags":"true","runAgentServiceAsUser":"false","userName":"","password":"","outputVariable":"","deploymentName":"$(deploymentName)","deploymentOutputs":"","addSpnToEnvironment":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Get Deployment Outputs","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"40936c25-3e9b-4afc-b6dc-b58d879a8058","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"deploymentOutputs=\"$(az group deployment show -g $(aksClusterGroupName) -n $(deploymentName) --query \"properties.outputs\" -o json)\"\n\naksApiServerAddress=$(echo $deploymentOutputs| jq -r .aksApiServerAddress.value)\naksClusterName=$(echo $deploymentOutputs| jq -r .aksClusterName.value)\napplicationGatewayName=$(echo $deploymentOutputs| jq -r .applicationGatewayName.value)\nidentityClientId=$(echo $deploymentOutputs| jq -r .identityClientId.value)\nidentityResourceId=$(echo $deploymentOutputs| jq -r .identityResourceId.value)\nresourceGroupName=$(echo $deploymentOutputs| jq -r .resourceGroupName.value)\nsubscriptionId=$(echo $deploymentOutputs| jq -r .subscriptionId.value)\n\necho \"##vso[task.setvariable variable=aksApiServerAddress]$aksApiServerAddress\"\necho \"##vso[task.setvariable variable=aksClusterName]$aksClusterName\"\necho \"##vso[task.setvariable variable=applicationGatewayName]$applicationGatewayName\"\necho \"##vso[task.setvariable variable=identityClientId]$identityClientId\"\necho \"##vso[task.setvariable variable=identityResourceId]$identityResourceId\"\necho \"##vso[task.setvariable variable=resourceGroupName]$resourceGroupName\"\necho \"##vso[task.setvariable variable=subscriptionId]$subscriptionId\"\n","args":"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Get AKS Credentials","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"40936c25-3e9b-4afc-b6dc-b58d879a8058","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"az aks get-credentials --resource-group $(aksClusterGroupName) --name $(aksClusterName)\n\n","args":"","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Set Node Resource Permissions","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"40936c25-3e9b-4afc-b6dc-b58d879a8058","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"nodeResourceGroupName=$(az aks show -n $(aksClusterName) -g $(aksClusterGroupName) --query \"nodeResourceGroup\" -o tsv)\nnodeResourceGroupId=$(az group show -g $nodeResourceGroupName --query \"id\" -o tsv)\n\n\nidentityName=$(az identity show --ids $(identityResourceId) --query \"name\" -o tsv)\n\nidentityPrincipalId=$(az identity show -n $identityName -g $(aksClusterGroupName) --query \"principalId\" -o tsv)\n\naz role assignment create --role Contributor --assignee-object-id \"$identityPrincipalId\" --scope \"$nodeResourceGroupId\"\n","args":"","addSpnToEnvironment":"true","useGlobalConfig":"false","cwd":"","failOnStandardError":"false"}},{"environment":{},"taskId":"8413c881-4959-43d5-8840-b4ea0ffc5cfd","version":"0.*","name":"Install Kubectl 1.17.2","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"kubectlVersion":"1.17.2"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"kubectl Create RBAC Disabled Cluser","refName":"","enabled":true,"alwaysRun":false,"continueOnError":true,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","kubernetesServiceEndpoint":"","azureSubscriptionEndpoint":"40936c25-3e9b-4afc-b6dc-b58d879a8058","azureResourceGroup":"$(aksClusterGroupName)","kubernetesCluster":"$(aksClusterName)","useClusterAdmin":"false","namespace":"","command":"create","useConfigurationFile":"false","configurationType":"configuration","configuration":"","inline":"","arguments":"-f https://raw.githubusercontent.com/Azure/aad-pod-identity/master/deploy/infra/deployment.yaml","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"068d5909-43e6-48c5-9e01-7c8a94816220","version":"0.*","name":"Install Helm 2.14.3","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"helmVersion":"2.14.3","checkLatestHelmVersion":"false","installKubeCtl":"true","kubectlVersion":"1.10.3","checkLatestKubeCtl":"false"}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm init RBAC Disabled","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"40936c25-3e9b-4afc-b6dc-b58d879a8058","azureResourceGroup":"$(aksClusterGroupName)","kubernetesCluster":"$(aksClusterName)","useClusterAdmin":"false","kubernetesServiceEndpoint":"","namespace":"","command":"init","chartType":"Name","chartName":"","chartPath":"","version":"","releaseName":"","overrideValues":"","valueFile":"","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":"","failOnStderr":"true"}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm repo","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"40936c25-3e9b-4afc-b6dc-b58d879a8058","azureResourceGroup":"$(aksClusterGroupName)","kubernetesCluster":"$(aksClusterName)","useClusterAdmin":"false","kubernetesServiceEndpoint":"","namespace":"","command":"repo","chartType":"FilePath","chartName":"","chartPath":"$(System.DefaultWorkingDirectory)/_snapfisher_Lab6AksDo/lab6project/helm-config.yaml","version":"","releaseName":"","overrideValues":"","valueFile":"","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"add application-gateway-kubernetes-ingress https://appgwingress.blob.core.windows.net/ingress-azure-helm-package/","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":"","failOnStderr":"true"}},{"environment":{},"taskId":"afa7d54d-537b-4dc8-b60a-e0eeea2c9a87","version":"0.*","name":"helm repo","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","azureSubscriptionEndpoint":"40936c25-3e9b-4afc-b6dc-b58d879a8058","azureResourceGroup":"$(aksClusterGroupName)","kubernetesCluster":"$(aksClusterName)","useClusterAdmin":"false","kubernetesServiceEndpoint":"","namespace":"","command":"repo","chartType":"Name","chartName":"","chartPath":"","version":"","releaseName":"","overrideValues":"","valueFile":"","destination":"$(Build.ArtifactStagingDirectory)","canaryimage":"false","upgradetiller":"true","updatedependency":"false","save":"true","install":"true","recreate":"false","resetValues":"false","force":"false","waitForExecution":"true","arguments":"update","enableTls":"false","caCert":"","certificate":"","privatekey":"","tillernamespace":"","failOnStderr":"true"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Helm Install AGIC","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"helm install --set appgw.name=$(applicationGatewayName) --set appgw.subscriptionId=$(subscriptionId) --set appgw.resourceGroup=$(aksClusterGroupName) --set appgw.usePrivateIP=false --set armAuth.type=aadPodIdentity --set armAuth.identityResourceID=$(identityResourceId) --set armAuth.identityClientID=$(identityClientId) application-gateway-kubernetes-ingress/ingress-azure\n","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"taskId":"8413c881-4959-43d5-8840-b4ea0ffc5cfd","version":"0.*","name":"Install Kubectl 1.17.2","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"kubectlVersion":"1.17.2"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"kubectl apply","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Azure Resource Manager","kubernetesServiceEndpoint":"","azureSubscriptionEndpoint":"40936c25-3e9b-4afc-b6dc-b58d879a8058","azureResourceGroup":"$(aksClusterGroupName)","kubernetesCluster":"$(aksClusterName)","useClusterAdmin":"false","namespace":"","command":"apply","useConfigurationFile":"false","configurationType":"configuration","configuration":"","inline":"","arguments":"-f https://raw.githubusercontent.com/Azure/application-gateway-kubernetes-ingress/master/docs/examples/aspnetapp.yaml ","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":133,"url":"https://vsrm.dev.azure.com/restonmtc/3501c2e2-491f-4971-893e-6994da3274e8/_apis/Release/releases/133","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{"dataSourceBindings":[{"parameters":{},"endpointId":"$(azureSubscriptionEndpoint)","target":"kubernetesCluster","resultTemplate":"{{{name}}}","endpointUrl":"{{{endpoint.url}}}/subscriptions/{{{endpoint.subscriptionId}}}/resourceGroups/$(azureResourceGroup)/providers/Microsoft.ContainerService/managedClusters?api-version=2017-08-31","resultSelector":"jsonpath:$.value[*]"},{"parameters":{},"endpointId":"$(azureSubscriptionEndpoint)","target":"azureResourceGroup","resultTemplate":"{{{ #extractResource id resourcegroups}}}","endpointUrl":"{{{endpoint.url}}}/subscriptions/{{{endpoint.subscriptionId}}}/providers/Microsoft.ContainerService/managedClusters?api-version=2017-08-31","resultSelector":"jsonpath:$.value[*]"}]},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/restonmtc/_apis/public/Release/badge/3501c2e2-491f-4971-893e-6994da3274e8/2/2"}],"artifacts":[{"sourceId":"4d428a7f-ed57-468f-a2fd-eee0a87f40e6:snapfisher/Lab6AksDo","type":"GitHub","alias":"_snapfisher_Lab6AksDo","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://github.com/snapfisher/Lab6AksDo","name":""},"branch":{"id":"master","name":"master"},"checkoutNestedSubmodules":{"id":"True","name":"Any nested submodules within"},"checkoutSubmodules":{"id":"","name":""},"connection":{"id":"4d428a7f-ed57-468f-a2fd-eee0a87f40e6","name":"Connection to snapfisher/Lab6AksDo"},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionType":{"id":"latestFromBranchType","name":"Latest from the default branch"},"definition":{"id":"snapfisher/Lab6AksDo","name":"snapfisher/Lab6AksDo"},"fetchDepth":{"id":"","name":""},"gitHubRepositoryId":{"id":"","name":""},"gitLfsSupport":{"id":"","name":""}},"isPrimary":true,"isRetained":false}],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseNew"},"IntegrateBoardsWorkItems":{"$type":"System.String","$value":"False"},"IntegrateJiraWorkItems":{"$type":"System.String","$value":"false"}},"id":2,"name":"IaC Pipeline","path":"\\","projectReference":null,"url":"https://vsrm.dev.azure.com/restonmtc/3501c2e2-491f-4971-893e-6994da3274e8/_apis/Release/definitions/2","_links":{"self":{"href":"https://vsrm.dev.azure.com/restonmtc/3501c2e2-491f-4971-893e-6994da3274e8/_apis/Release/definitions/2"},"web":{"href":"https://dev.azure.com/restonmtc/3501c2e2-491f-4971-893e-6994da3274e8/_release?definitionId=2"}}}